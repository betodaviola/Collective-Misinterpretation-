<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Roberto Mochetti">
    <meta name="description" content="Roberto Mochetti is a viola player, teacher, arranger, and composer. Passionate about experimental and chamber music, he has played, studied, and taught in Brazil, the United States, and in Denmark. Today, Roberto is working on his Doctor of Musical Arts degree at LSU, focusing on viola performance with a minor in experimental music and digital media.">
    <title>adminPage - Collective Misinterpretation</title>

    <link rel="stylesheet" type="text/css" href="../normalize.css">
    <link rel="stylesheet" type="text/css" href="../style.css">
    <script src="https://kit.fontawesome.com/913023e2fb.js" crossorigin="anonymous"></script>
  </head>
  <body class="gradient">
    <h1>[admin page] Collective Misinterpretation</h1>
    <p>PLEASE RESET BEFORE EVERY RUN!</p>
    <p>
      <button class="button" id="openBtn">OPEN FORM</button>
      <button class="button" id="closedBtn">CLOSE FORM</button>
      <button class="button" id="resetBtn">RESET</button>
    </p>

    <section class="card-normal">
      <h2>Status</h2>
      <p id="formStatus">Form is currently <u id="statusText">closed</u><span id="countSentence"></span>.</p>

      <p>Current movement: <u><i id="movDisplay">0</i></u></p>
    </section>
     
    <footer>
      <div class="fa-wrapper">
        <a href="https://github.com/betodaviola?tab=repositories" title="GitHub Repositories" target="_blank" rel="noopener noreferrer"><i class="fa-brands fa-github"></i></a>
      </div>
    </footer>
    <script>
      let status = "closed";
      let mov = "0";

      let countdown = 0;
      let countdownInterval = null;
      const formTime = 10; //Remember to set this appropriatelly based on the length of the movement

      function sendRequest(status) { // this function uses fetch() to send a request to the php via AJAX, so the page is not refreshed with each request
        fetch('./../input_handler.php', {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},// standard header format to simulate a form being sent
          body: `btnStatus=${status}` //this is the actual data, simulating the previous code onn the button tag
        }) 
        .then(response => response.text()) //this is where it gets weird: fectch() returns a Promise (object that gives a result). This result is handled by the .then() block. On this case we are getting the response as text
        .then(statusData => {
        //  console.log(statusData); //See what the server responded, but you can add any code here that would use the server response

          let statusArray = statusData.split(" | ");
          let status = statusArray[0];
          let mov = statusArray[1];

          const formStatus = document.getElementById('formStatus');
          const statusText = document.getElementById('statusText');
          const movDisplay = document.getElementById('movDisplay');
          const countSentence = document.getElementById('countSentence');

          movDisplay.textContent = mov;

          if (status == "open") {
            countdown = formTime;
            statusText.textContent = 'active';
            clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
              countdown--;
              countSentence.textContent = ' for ' + countdown + ' more seconds';
              if (countdown <= 0) {
                sendRequest('closed');
              }
            }, 1000);
          } else {
            clearInterval(countdownInterval);
            statusText.textContent = 'closed';
            countSentence.textContent = '';
          }
        })
      }
      // Attach click handlers. note that on click, the sendRequest(status)above is executed, using the fetch() in the process
      document.getElementById('openBtn').addEventListener('click', () => {
        sendRequest('open');
      });
      document.getElementById('closedBtn').addEventListener('click', () => {
        sendRequest('closed');
      });
      document.getElementById('resetBtn').addEventListener('click', () => {
        sendRequest('reset');
      });
    </script>
  </body>
</html>