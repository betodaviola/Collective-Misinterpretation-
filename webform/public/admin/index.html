<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Roberto Mochetti">
    <meta name="description" content="Roberto Mochetti is a viola player, teacher, arranger, and composer. Passionate about experimental and chamber music, he has played, studied, and taught in Brazil, the United States, and in Denmark. Today, Roberto is working on his Doctor of Musical Arts degree at LSU, focusing on viola performance with a minor in experimental music and digital media.">
    <title>adminPage - Collective Misinterpretation</title>

    <link rel="stylesheet" type="text/css" href="../normalize.css">
    <link rel="stylesheet" type="text/css" href="../style.css">
    <script src="https://kit.fontawesome.com/913023e2fb.js" crossorigin="anonymous"></script>
  </head>
  <body class="gradient">
    <h1>[admin page] Collective Misinterpretation</h1>
    <button type="button" class="collapse">
      Instructions: <span style="font-size: 0.7rem;">(Click to expand)</span>
    </button>
    <div class="collapseContent">
      <p>Before running the piece:</p>
      <ol>
        <li>Click the RESET button. This will create a backup of any previous database.</li>
        <li>Start the local script and answer yes (1) to clean the local directories. This will delete every data from previous run without any automatic backup.</li>
        <li>Wait for the warm-up to finish, and then the piece can start.</li>
        <li> Click the OPEN FORM button at the start of every movement and wait for the form to close automatically.</li>
      </ol>

    </div>
    
    <p>
      <button class="button" id="openBtn">OPEN FORM</button>
      <button class="button" id="closedBtn">CLOSE FORM</button>
      <button class="button" id="resetBtn">RESET</button>
    </p>

    <section class="card-normal">
      <h2>Status</h2>
      <p id="formStatus">Form is currently <u id="statusText">closed</u><span id="countSentence"></span>.</p>
      <p>Current movement: <u><i id="movDisplay">0</i></u></p>
      <p id="mergeStatus"></p>
    </section>
     
    <footer>
      <div class="fa-wrapper">
        <a href="https://github.com/betodaviola?tab=repositories" title="GitHub Repositories" target="_blank" rel="noopener noreferrer"><i class="fa-brands fa-github"></i></a>
      </div>
    </footer>
    <script>
      //collapsable instrucion section
      document.querySelector('.collapse').addEventListener('click', function () {
        const content = document.querySelector('.collapseContent');
        content.style.display = (content.style.display === 'block') ? 'none' : 'block';
      });

      // DID IT GO THROUGH OR NOT
      let currentStatus = null;
      let mov = "0";

      let interval = null;

      const mergeStatus = document.getElementById('mergeStatus');
      openBtn.disabled = false;
      closedBtn.disabled = true;
      resetBtn.disabled = false;

      async function backupInputs() {
        resetBtn.disabled = true;
        openBtn.disabled = true;
        mergeStatus.textContent = "Backing up stored input and cleaning folder...";
        fetch('input-backup.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
        }) 
        .then(response => response.text()) 
        .then(data => {
          console.log(data); //See what the server responded, but you can add any code here that would use the server response
          mergeStatus.textContent = data;
          resetBtn.disabled = false;
          openBtn.disabled = false;
        })
      }
      async function mergeInputs() {
        openBtn.disabled = true;
        resetBtn.disabled = true;
        mergeStatus.textContent = "Creating input database...";
        fetch('merger.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
        }) 
        .then(response => response.text()) 
        .then(data => {
          console.log(data); //See what the server responded, but you can add any code here that would use the server response
          mergeStatus.textContent = data;
          openBtn.disabled = false;
          resetBtn.disabled = false;
        })
      }


      function sendRequest(action) { // this function uses fetch() to send a request to the php via AJAX, so the page is not refreshed with each request
        fetch('form-handler.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
           // 'Accept': 'text/plain' //important for running these buttons on the same page
          },// standard header format to simulate a form being sent
          body: `btnStatus=${action}` //this is the actual data, simulating the previous code onn the button tag
        }) 
        .then(response => response.text()) //this is where it gets weird: fectch() returns a Promise (object that gives a result). This result is handled by the .then() block. On this case we are getting the response as text
        .then(data => {
          console.log(data); //See what the server responded, but you can add any code here that would use the server response

          const [serverStatus, serverMov] = data.trim().split(" | ");
          mov = serverMov;
          document.getElementById('movDisplay').textContent = mov;


        //  const formStatus = document.getElementById('formStatus');
          const statusText = document.getElementById('statusText');
          const countSentence = document.getElementById('countSentence');

          movDisplay.textContent = mov;
          
          const prevStatus = currentStatus; //preserves previous status on new variable to identify status changes
          currentStatus = serverStatus; // update this javascript status

          if (serverStatus === "open") {
            statusText.textContent = 'open';
            closedBtn.disabled = false;
            openBtn.disabled = true;
            clearInterval(interval);
            fetch("../target-time.php")
              .then(res => res.json())
              .then(data => {
                const targetTime = data.target_time;
                console.log(targetTime);
                interval = setInterval(() => {
                  const now = Math.floor(Date.now() / 1000);
                  const remaining = targetTime - now;
                  if (remaining <= 0) {
                    closedBtn.disabled = true;
                    clearInterval(interval);
                    countSentence.textContent = '';
                    statusText.textContent = 'closed';
                    sendRequest('closed');
                    mergeInputs();
                    return;
                  }
                  countSentence.textContent = ' for ' + remaining + ' more seconds';
                }, 1000);
              })
              .catch(err => {
                console.error("Failed to load target time:", err);
                countSentence.textContent = "";
              });
            // } else if (serverStatus === "closed") {
          } else {
            closedBtn.disabled = true;
            clearInterval(interval);
            statusText.textContent = 'closed';
            countSentence.textContent = '';
          }
        })
      }

      // Attach click handlers. note that on click, the sendRequest(status)above is executed, using the fetch() in the process
      document.getElementById('openBtn').addEventListener('click', () => {
        openBtn.disabled = true;
        sendRequest('open');
        mergeStatus.textContent = "";
      });
      document.getElementById('closedBtn').addEventListener('click', () => {
        closedBtn.disabled = true;
        sendRequest('closed');
        mergeInputs()
      });
      document.getElementById('resetBtn').addEventListener('click', () => {
        closedBtn.disabled = true;
        sendRequest('reset');
        backupInputs();
      });
      sendRequest('check');
    </script>
  </body>
</html>