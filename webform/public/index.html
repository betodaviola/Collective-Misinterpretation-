<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Roberto Mochetti">
    <meta name="description" content="Roberto Mochetti is a viola player, teacher, arranger, and composer. Passionate about experimental and chamber music, he has played, studied, and taught in Brazil, the United States, and in Denmark. Today, Roberto is working on his Doctor of Musical Arts degree at LSU, focusing on viola performance with a minor in experimental music and digital media.">
    <title>Webform - Collective Misinterpretation</title>

    <link rel="stylesheet" type="text/css" href="normalize.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="https://kit.fontawesome.com/913023e2fb.js" crossorigin="anonymous"></script>
  </head>
  <body class="gradient">
    <h1>Collective Misinterpretation</h1>
      <p>Describe the musical sounds you hear on each movement in the form below.</p>
      <p>You can use technical terms (e.g., melody, harmony, timbre, genre, style), abstract ideas (e.g., mood, emotions, feelings), or general impressions. </p>
      <p>You'll have approximately 50 seconds to write your description, after which the form will be deactivated and you will have the chance to listen to the movement a second time. The form reactivates for each new movement, and your answer is submitted automatically.</p>
      <p>You have <u><span id="counter">0</span> seconds</u> until automatic submission.</p>
      
      <!-- handle audience live descriptions-->
      <form id="movementForm" method="post">
          <p><textarea id="movementInput" name="mov_description" placeholder="type your description here" spellcheck="true" rows="7" autocomplete="off" autofocus disabled></textarea></p>
          <!-- Activate if you need manual submission, although IT WILL REFRESH THE PAGE: -->
          <!-- <p><button class="button" type="submit">SUBMIT</button></p>-->
      </form>
    <footer>
      <div class="fa-wrapper">
        <a href="https://github.com/betodaviola?tab=repositories" title="GitHub Repositories" target="_blank" rel="noopener noreferrer"><i class="fa-brands fa-github"></i></a>
      </div>
    </footer>
    <script>

      let interval = null;

      let formEnabled = false;

      

      const countdownDisplay = document.getElementById('counter');
      const movementForm = document.getElementById('movementForm');
      const movementInput = document.getElementById('movementInput');

      //check formStatus.txt every 2 seconds and enable/disable form
      async function checkFormStatus() { //asynnc means it returs a promise (useful for online requests as a promisse can be pending/fulfilled(resolved)/rejected
        try { 
          const response = await fetch(`status.php?t=${Date.now()}`, { //await is only used inside async. it pauses this function untill promise resolves or fails. On this case it waits until fetch responds
            //the date now above makes every request unique by using very long number in milisseconds, making sure there is not cashed information for this regardless of browses
            cache: 'no-store',
            headers: {
              'Cache-Control': 'no-cache'
            }
          });

          const status = await response.text(); //waits untill text is extracted

          if (status.startsWith('open')) {
            enableForm();
          } else if (status.startsWith('closed') && formEnabled) {
            await disableForm();
          }
        } catch (error) {
          console.error(error);
        }
      }

      function enableForm() {
        if (formEnabled === false) { //avoids it trying to run every 2 seconds and fixed countdown (does not run if form already open)
          formEnabled = true;
          document.getElementById("movementForm").reset();
          //countdown stuff. found it online and need to actually learn some of these methods 
          fetch("target-time.php")
            .then(res => res.json())
            .then(data => {
              const targetTime = data.target_time;
              if (interval) {
                clearInterval(interval);
              }
              console.log(targetTime);
              interval = setInterval(() => {
                const now = Math.floor(Date.now() / 1000);
                const remaining = targetTime - now;
                if (remaining <= 0) {
                  clearInterval(interval);
                  countdownDisplay.textContent = '0';
                  return;
                }
                countdownDisplay.textContent = remaining;
              }, 1000);
            })
            .catch(err => {
              console.error("Failed to load target time:", err);
              countSentence.textContent = "err";
            });
        }
        movementInput.disabled = false; //actually activates the form
      }

      // --- Use this corrected version of disableForm ---

      function disableForm() {
          // 1. Immediately set the state.
          formEnabled = false;

          // 2. If the input is empty, just disable and exit.
          if (!movementInput.value.trim()) {
              console.log("Form is empty, not submitting.");
              movementInput.disabled = true; // Still disable it
              countdownDisplay.textContent = '0';
              if (interval) {
                  clearInterval(interval);
                  interval = null;
              }
              return;
          }

          // 3. CAPTURE THE DATA FIRST! (While the input is still enabled)
          const formData = new FormData(movementForm);

          // 4. NOW, disable the form and update the UI for the user.
          movementInput.disabled = true;
          countdownDisplay.textContent = '0';
          if (interval) {
              clearInterval(interval);
              interval = null;
          }
          
          const randomDelay = Math.random() * 3000;
          console.log(`Submission scheduled in ${Math.round(randomDelay)} ms.`);

          // 5. Schedule the submission using the data you already captured.
          setTimeout(() => {
              fetch('submit.php', {
                      method: "POST",
                      body: formData,
                  })
                  .then(response => response.text())
                  .then(data => {
                      console.log("Submission successful:", data);
                  })
                  .catch(error => {
                      console.error("Submission failed:", error);
                  });
          }, randomDelay);
      }

      setInterval(checkFormStatus, 2000); //poll every 2 seconds
      checkFormStatus(); //poll immediately when page loads regardless of setInterval()
    </script>

  </body>
</html>